name: Python CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # 1Ô∏è‚É£  Checkout the repository
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------
      # 2Ô∏è‚É£  Set up Python environment
      # -----------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # -----------------------------
      # 3Ô∏è‚É£  Install dependencies
      # -----------------------------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          else
            echo "‚ö†Ô∏è  requirements.txt not found, skipping dependency install."
          fi

      # -----------------------------
      # 4Ô∏è‚É£  Run tests with pytest
      # -----------------------------
      - name: Run tests
        run: pytest || echo "‚ö†Ô∏è  Tests failed or not present, continuing..."

      # -----------------------------
      # 5Ô∏è‚É£  Install system dependencies
      # (needed for running ScaResolver)
      # -----------------------------
      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libc6

      # -----------------------------
      # 6Ô∏è‚É£  Download and set up ScaResolver
      # -----------------------------
      - name: Download and Extract ScaResolver
        run: |
          wget https://sca-downloads.s3.amazonaws.com/cli/latest/ScaResolver-linux64.tar.gz -O ScaResolver-linux64.tar.gz
          echo "üì¶ Extracting ScaResolver..."
          tar -xzf ScaResolver-linux64.tar.gz
          chmod +x ./ScaResolver
          echo "‚úÖ ScaResolver extracted successfully."
          echo "Binary details:"
          file ./ScaResolver
          ./ScaResolver --help || echo "‚ö†Ô∏è  ScaResolver help command failed."

      # -----------------------------
      # 7Ô∏è‚É£  Verify ScaResolver path
      # -----------------------------
      - name: Verify ScaResolver Path
        run: |
          echo "Current directory: $PWD"
          ls -la
          echo "Checking ScaResolver executable:"
          ./ScaResolver --version || ./ScaResolver --help

      # -----------------------------
      # 8Ô∏è‚É£  Run Checkmarx One scan
      # -----------------------------
      - name: Checkmarx One CLI Action
        uses: checkmarx/ast-github-action@main
        with:
          project_name: python
          cx_tenant: cdac
          base_uri: https://ind.ast.checkmarx.net
          cx_client_id: ${{ secrets.CX_CLIENT_ID }}
          cx_client_secret: ${{ secrets.CX_CLIENT_SECRET }}
          additional_params: --sca-resolver "$PWD/ScaResolver" --sca-resolver-params "--log-level Debug"
